---
title: "pp346_ps1_steiner"
author: "erika steiner"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, results = 'hide'}
knitr::opts_chunk$set(echo = TRUE)
library("haven")
# https://martinctc.github.io/blog/working-with-spss-labels-in-r/
library("tidyverse")
library("broom")
library("stringr")
library("sandwich")
library("lmtest")
library("car")
options(scipen=999)
```

## Overarching Questions
(A) How did FTP change the behavior of welfare recipients?

(B) What can we say about the effects of the time limit as opposed to other
components of the program?

## Analysis Questions

(2) Open the file ftp_ar.dta. What is the number of observations? Of observations in the treatment and control groups? Do your numbers match those from the documentation?

```{r import data}
ftp_ar <- read_dta("ftp_ar.dta")

# "What is the number of observations"
ftp_ar %>% nrow()
# Answer: 2815
# TK format

# What is the number of observations in treatment and control groups?
ftp_ar %>% count(e)
# Treatment: e = 1, Answer: 1405
# Control: e = 0, Answer: 1410
# TK format

# Yes, these numbers match (see page 8)
```


(3) Verify the data by replicating the control-group means in the file “Annotated AR
table 1_U.xls.” Restrict attention to the following subset of variables:
(a) quarterly employment, quarter of RA to quarter 18;

```{r control qemp mean}
# create vector of employment quarter columns 1-19
# for quarter of RA to quarter 18, this will be quarter 1 to 19 -- see data documentation pg. 19
empq_cols <- c("empq1", "empq2", "empq3", "empq4", "empq5", "empq6", "empq7", "empq8", "empq9", "empq10", "empq11", "empq12", "empq13", "empq14", "empq15", "empq16", "empq17", "empq18", "empq19")

c_empq_means_table <- 
  # use admin data set
  ftp_ar %>% 
  # filter for control group
  filter(e == 0) %>% 
  # isolate employment quarter columns
  select (all_of(empq_cols)) %>% 
  # calculate the mean of each column
  summarise(across(everything(), ~ mean (., na.rm = TRUE))) %>% 
  # convert means to percentages (multiply by 100)
  mutate(across(everything(), ~ . * 100))

# format as table TK
```

(b) any AFDC/TANF payments, quarter of RA to quarter 18;
```{r control any afdc mean}
any_afdc_cols <- c("recc1", "recc2", "recc3", "recc4", "recc5", "recc6", "recc7", "recc8", "recc9", "recc10", "recc11", "recc12", "recc13", "recc14", "recc15", "recc16", "recc17", "recc18", "recc19")

c_afdc_means_table <-
  # use admin data set
  ftp_ar %>% 
  # filter for control group
  filter(e == 0) %>% 
  # isolate afdc/tanf payment columns
  select (all_of(any_afdc_cols)) %>% 
  # calculate the mean of each column
  summarise(across(everything(), ~ mean (., na.rm = TRUE))) %>% 
  # convert means to percentages (multiply by 100)
  mutate(across(everything(), ~ . * 100))
```

(b) any Food Stamp payments, quarter of RA to quarter 18;
```{r control any food stamp mean}
rfsc_cols <- c("rfsc1", "rfsc2", "rfsc3", "rfsc4", "rfsc5", "rfsc6", "rfsc7", "rfsc8", "rfsc9", "rfsc10", "rfsc11", "rfsc12", "rfsc13", "rfsc14", "rfsc15", "rfsc16", "rfsc17", "rfsc18", "rfsc19")

c_rfsc_means_table <-
   # use admin data set
  ftp_ar %>% 
  # filter for control group
  filter(e == 0) %>% 
  # isolate afdc/tanf payment columns
  select (all_of(rfsc_cols)) %>% 
  # calculate the mean of each column
  summarise(across(everything(), ~ mean (., na.rm = TRUE))) %>% 
  # convert means to percentages (multiply by 100)
  mutate(across(everything(), ~ . * 100))
```

Are there any discrepancies? 
TK RFSC Quarter 17
While you are at it, comment on the levels of
employment among the people in the study population.
TK Slow increase over time

(4) Compare your results to those in Table B.1 of Bloom et al (2000). Why are they
different? How do you expect these differences to affect your results?
- Different because data is different (page 3)
TK

(5) Test for balance. To do so, use all variables whose labels contain the string
“cova:”. These are pre-RA variables that MDRC sometimes used as controls.

```{r cova_table}
# create a table including only covariate columns and treatment dummy
# covariate columns can be identified by "cova" in column label

# https://stackoverflow.com/questions/67664582/is-it-possible-to-select-columns-based-on-variable-labels 

cova_table <- ftp_ar %>% 
  # select treatment dummy column 
  select("e", 
    # and columns where...
    where(~ {
    # the column's label
    column_label <- attributes(.)$label
    # is not null AND contains 'cova' (returns TRUE)
    !is.null(column_label) && str_detect(column_label, 'cova')
    }))
```

Conduct two simple tests. First, regress each variable on the treatment dummy. 
Comment on your choice of which standard errors to compute.

```{r regress each}
# regress each covariate on the treatment dummy
cova_regress <- cova_table %>% 
  # pivot the data to allow for grouping by covariate
  pivot_longer(cols = -e, names_to = "covariate", values_to = "value") %>% 
  group_by(covariate) %>% 
  group_map(~{
    # regress each covariate on treatment dummy
    regress <- lm(value ~ e, data = .)
    
    # calculate using robust standard errors
    robust_se <- sqrt(diag(vcovHC(regress, type = "HC1")))
    
    # tidy the regression table
    regress_table <- tidy(regress) %>% 
      mutate(covariate = toString(.y)) %>% 
      mutate(robust_se = robust_se)
    
    
    regress_table
    }) %>% 
  bind_rows() %>% 
  ungroup()

print(cova_regress)

# tk
# comment everything
# clean up this silly table
# explain heterosk standard errors
```

How many times do you reject the null at the 5% level? Roughly how many rejections would you expect
under the null of random assignment? 

```{r rejecting null}
# identify n rows where p.value 
cova_regress %>% 
  filter(term == "e") %>% 
  filter(p.value <0.05)

# 0 rejections
# expect 1 in 20?


```

Second, regress the treatment dummy on all
the variables together and conduct a joint test for balance. 

```{r regress all}
# regress treatment dummy on all variables together
allcova_regress <- lm(e ~ ., data = cova_table)
summary(allcova_regress)
# conduct joint test for balance
# per Ed Discussion board, installing car

vif(allcova_regress)

# excluding yrearnsq

cova_balance <- linearHypothesis(allcova_regress, c("yr2adc = 0", "yradc = 0", "yr2rec = 0", "yrrec = 0", "yrkrec = 0", "yrearn = 0", "yr2earn = 0", "yremp = 0", "yr2emp = 0", "yrkemp = 0", "yr2kemp = 0", "yr2fs = 0", "yrfs = 0", "yr2rfs = 0", "yrrfs = 0", "yrkrfs = 0"))

```



Explain your choice of
degrees of freedom in computing this test. Do the two tests yield the same
conclusion? What do you conclude about the overall balance of the sample?

```{r balance}

# 16 df because had to exclude yrearnsq

# F Values high

# Neither test rejects the null 

```



(6) Returning to the post-RA data, estimate simple treatment effects such as those
shown in “Annotated AR table 1_U.xls.” Can you replicate those results? Restrict
attention again to the variables from question (3).


Replicate 3 w/ treatment (e = 1)






(7) What type of treatment effects do your estimates identify? How do you interpret
them?

I think naive estimator?


(8) To distinguish the effects of the time limits from the other components of the
reform program, Grogger and Michalopoulos proposed to estimate the effects of FTP
by the age of the youngest child in the family. You’ll do the same. This will require
knowing who was assigned to a 24-month time limit, and who was assigned a 36-
month time limit. Use the actual time limit for the treatment group and the imputed
time limit for the control group. Find and tabulate the relevant variables. How many
observations are in each group?





(9) Define four age groups as a function of the age of the youngest child in the family
during the quarter of random assignment: (0) less than 3 years; (i) 3-8 years; (ii) 9-
14 years (for families with a 36-month time limit) or 9-15 years (for families with a
24-month time limit); (iv) 15-19 (for families with a 36-month time limit) or 16-19
years (for families with a 24-month time limit). By treatment status, how many
families are in each age group?


(10) Estimate age-group-specific treatment effects of FTP on number of months of
AFDC receipt and Food Stamp receipt, and number of quarters of employment ,
during the first 24 months after random assignment. Are the estimates of the effects
on AFDC receipt consistent with the hypothesis that time limits should have
stronger effects, the younger the youngest child in the family? Note that families in
age group (iv) (from Question 9) shouldn’t be affected by time limits at all. They are
only affected by the other components of the program, so they provide an estimate
of the collective effect of those components. Under some assumptions, you can
estimate the effects of the time limit on the younger age groups as the difference
between the age-group specific effects of the reform and the effect of the reform on
the oldest age group.


(11) To your regression from (10) add a dummy that equals one if the family has a
36-month time limit. Reassess the evidence for whether time limits have stronger
effects, the younger the youngest child in the family. Explain the difference between
these estimates and those that do not control for the length of the time limit.
